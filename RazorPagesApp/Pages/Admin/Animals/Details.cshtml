@page "/admin/animals/details/{id:int}"
@model RazorPagesApp.Pages.Admin.Animals.DetailsModel
@using ClassLibrary.Features.AnimalManagement.Core.Enums
@using ClassLibrary.SharedKernel.Extensions
@using System.Text.Json

@{    ViewData["Title"] = Model.Animal != null ? $"Detaljer for {Model.Animal.Name}" : "Dyredetaljer";
    Layout = "/Pages/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

@if (Model.Animal == null)
{
    <h1>Dyredetaljer</h1>
    <div class="alert alert-warning" role="alert">
        Dyret blev ikke fundet.
    </div>
    <p>
        <a asp-page="./Index" class="btn btn-outline-secondary">Tilbage til listen</a>
    </p>
}
else
{
    <h1>@ViewData["Title"]</h1>

    <div>
        <h4>Generel Information</h4>
        <hr />
        <dl class="row">
            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.Id)</dt>
            <dd class="col-sm-9">@Html.DisplayFor(model => model.Animal.Id)</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.Name)</dt>
            <dd class="col-sm-9">@Html.DisplayFor(model => model.Animal.Name)</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.Species)</dt>
            <dd class="col-sm-9">@Html.DisplayFor(model => model.Animal.Species)</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.Breed)</dt>
            <dd class="col-sm-9">@Html.DisplayFor(model => model.Animal.Breed)</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.BirthDate)</dt>
            <dd class="col-sm-9">@Model.Animal.BirthDate?.ToString("dd-MM-yyyy")</dd>
            
            <dt class="col-sm-3">Alder</dt>
            <dd class="col-sm-9">@Model.Animal.GetFormattedAge()</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.Gender)</dt>
            <dd class="col-sm-9">@Html.DisplayFor(model => model.Animal.Gender)</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.Description)</dt>
            <dd class="col-sm-9" style="white-space: pre-wrap;">@Html.DisplayFor(model => model.Animal.Description)</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.IntakeDate)</dt>
            <dd class="col-sm-9">@Model.Animal.IntakeDate.ToString("dd-MM-yyyy HH:mm")</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.Weight)</dt>
            <dd class="col-sm-9">@Html.DisplayFor(model => model.Animal.Weight) kg</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.HealthStatus)</dt>
            <dd class="col-sm-9">@Html.DisplayFor(model => model.Animal.HealthStatus)</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.Status)</dt>
            <dd class="col-sm-9">@Model.Animal.Status.GetDisplayName()</dd>

            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.PictureUrl)</dt>
            <dd class="col-sm-9">
                @if (!string.IsNullOrWhiteSpace(Model.Animal.PictureUrl))
                {
                    <img src="@Model.Animal.PictureUrl" alt="Billede af @Model.Animal.Name" style="max-width: 200px; max-height: 200px;" class="img-thumbnail mb-2" /><br />
                    <a href="@Model.Animal.PictureUrl" target="_blank">@Model.Animal.PictureUrl</a>
                }
                else
                {
                    <span>Intet billede</span>
                }
            </dd>
            
            <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.IsAdopted)</dt>
            <dd class="col-sm-9">@(Model.Animal.IsAdopted ? "Ja" : "Nej")</dd>

            @if (Model.Animal.IsAdopted)
            {
                <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.AdoptionDate)</dt>
                <dd class="col-sm-9">@Model.Animal.AdoptionDate?.ToString("dd-MM-yyyy")</dd>

                <dt class="col-sm-3">@Html.DisplayNameFor(model => model.Animal.AdoptedByCustomerId)</dt>
                <dd class="col-sm-9">@Html.DisplayFor(model => model.Animal.AdoptedByCustomerId)</dd>
            }
        </dl>
    </div>
    <hr />

    <div>
        <h4>Sundhedsjournaler (<span id="healthRecordsCount">@Model.HealthRecords.Count</span>)</h4>
        <button type="button" class="btn btn-sm btn-success mb-2" id="btnAddHealthRecord" data-animalid="@Model.Animal.Id">Tilføj Sundhedsnotat</button>
        <div id="healthRecordsTableContainer">
            @if (!Model.HealthRecords.Any())
            {
                <p>Ingen sundhedsjournaler fundet for dette dyr.</p>
                <table class="table table-sm table-bordered" style="display:none;">
                    <thead>
                        <tr><th>Dato</th><th>Dyrlæge</th><th>Diagnose</th><th>Behandling</th><th>Noter</th><th>Vaccineret</th><th>Næste Vaccine</th><th>Handlinger</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            }
            else
            {
                <p style="display:none;">Ingen sundhedsjournaler fundet for dette dyr.</p>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr><th>Dato</th><th>Dyrlæge</th><th>Diagnose</th><th>Behandling</th><th>Noter</th><th>Vaccineret</th><th>Næste Vaccine</th><th>Handlinger</th></tr>
                    </thead>
                    <tbody>
                        @foreach(var record in Model.HealthRecords.OrderByDescending(hr => hr.RecordDate))
                        {
                            <tr data-record-id="@record.Id">
                                <td>@record.RecordDate.ToString("dd-MM-yyyy")</td>
                                <td>@record.VeterinarianName</td>
                                <td>@record.Diagnosis</td>
                                <td>@record.Treatment</td>
                                <td>@record.Notes</td>
                                <td>@(record.IsVaccinated ? "Ja" : "Nej")</td>
                                <td>@record.NextVaccinationDate?.ToString("dd-MM-yyyy")</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-primary btnEditHealthRecord" data-recordid="@record.Id" data-animalid="@Model.Animal.Id">Rediger</button>
                                    <button type="button" class="btn btn-sm btn-outline-danger btnDeleteHealthRecord" data-recordid="@record.Id" data-animalid="@Model.Animal.Id" data-recordname="Notat fra @record.RecordDate.ToString("dd-MM-yyyy")">Slet</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>
    <hr />

    <div>
        <h4>Besøg (<span id="visitsCount">@Model.Visits.Count</span>)</h4>
        <button type="button" class="btn btn-sm btn-success mb-2" id="btnAddVisit" data-animalid="@Model.Animal.Id">Registrer Besøg</button>
        <div id="visitsTableContainer">
            @if (!Model.Visits.Any())
            {
                <p>Ingen besøg fundet for dette dyr.</p>
                <table class="table table-sm table-bordered" style="display:none;">
                    <thead>
                        <tr><th>Planlagt Dato</th><th>Varighed</th><th>Type</th><th>Formål</th><th>Besøgende</th><th>Status</th><th>Noter</th><th>Handlinger</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            }
            else
            {
                <p style="display:none;">Ingen besøg fundet for dette dyr.</p>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr><th>Planlagt Dato</th><th>Varighed</th><th>Type</th><th>Formål</th><th>Besøgende</th><th>Status</th><th>Noter</th><th>Handlinger</th></tr>
                    </thead>
                    <tbody>
                        @foreach(var visit in Model.Visits.OrderByDescending(v => v.PlannedDate))
                        {
                            <tr data-visit-id="@visit.Id">
                                <td>@visit.PlannedDate.ToString("dd-MM-yyyy HH:mm")</td>
                                <td>@visit.PlannedDuration min.</td>
                                <td>@visit.Type</td>
                                <td>@visit.Purpose</td>
                                <td>@visit.Visitor</td>
                                <td class="visit-status">@visit.Status.GetDisplayName()</td>
                                <td>@visit.Notes</td>
                                <td class="visit-actions">
                                    <button type="button" class="btn btn-sm btn-outline-primary btnEditVisit" data-visitid="@visit.Id" data-animalid="@Model.Animal.Id">Rediger</button>
                                    <button type="button" class="btn btn-sm btn-outline-danger btnDeleteVisit" data-visitid="@visit.Id" data-animalid="@Model.Animal.Id" data-visitname="Besøg d. @visit.PlannedDate.ToString("dd-MM-yyyy")">Slet</button>
                                    @if (visit.Status == VisitStatus.Scheduled)
                                    {
                                        <button type="button" class="btn btn-sm btn-outline-success btnConfirmVisit ms-1" data-visitid="@visit.Id">Bekræft</button>
                                        <button type="button" class="btn btn-sm btn-outline-warning btnCancelVisit ms-1" data-visitid="@visit.Id">Annuller</button>
                                    }
                                    else if (visit.Status == VisitStatus.Confirmed)
                                    {
                                        <button type="button" class="btn btn-sm btn-success btnCompleteVisit ms-1" data-visitid="@visit.Id">Fuldfør</button>
                                        <button type="button" class="btn btn-sm btn-outline-warning btnCancelVisit ms-1" data-visitid="@visit.Id">Annuller</button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    </div>

    <div class="mt-4">
        <a asp-page="./Edit" asp-route-id="@Model.Animal.Id" class="btn btn-primary">Rediger Dyr</a> 
        <a asp-page="./Index" class="btn btn-outline-secondary">Tilbage til listen</a>
    </div> 

    <!-- Modal for HealthRecord Opret/Rediger -->
    <div class="modal fade" id="healthRecordModal" tabindex="-1" role="dialog" aria-labelledby="healthRecordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="healthRecordModalLabel">Sundhedsnotat</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="healthRecordModalBody">
                    <!-- Formular indlæses her -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuller</button>
                    <button type="button" class="btn btn-primary" id="btnSaveHealthRecord">Gem</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Visit Opret/Rediger -->
    <div class="modal fade" id="visitModal" tabindex="-1" role="dialog" aria-labelledby="visitModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="visitModalLabel">Besøg</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="visitModalBody">
                    <!-- Formular indlæses her -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuller</button>
                    <button type="button" class="btn btn-primary" id="btnSaveVisit">Gem</button>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
        <script>
            // Definer globale JS variable som det eksterne script forventer
            var animalId = @Model.Animal.Id;
            var visitStatusEnum = @Html.Raw(JsonSerializer.Serialize(Enum.GetValues(typeof(VisitStatus)).Cast<VisitStatus>().ToDictionary(e => e.ToString(), e => e.ToString())));
        </script>
        <script src="~/js/admin/animal-details.js" asp-append-version="true"></script>
    }
} 